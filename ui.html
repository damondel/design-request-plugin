<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
      <title>CXS AI Chat Request</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
      padding: 16px;
    }

    .header {
      margin-bottom: 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .header p {
      color: var(--figma-color-text-secondary);
      font-size: 12px;
    }

    .section {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--figma-color-bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--figma-color-border);
    }

    .section h2 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--figma-color-text);
    }

    .selection-info {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .selection-count {
      background: var(--figma-color-bg-brand);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .button {
      background: var(--figma-color-bg-brand);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.2s;
    }

    .button:hover {
      background: var(--figma-color-bg-brand-hover);
    }

    .button:disabled {
      background: var(--figma-color-bg-disabled);
      cursor: not-allowed;
    }

    .button.secondary {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }

    .button.secondary:hover {
      background: var(--figma-color-bg-hover);
    }

    .loading {
      display: none;
      align-items: center;
      gap: 8px;
      margin: 16px 0;
      color: var(--figma-color-text-secondary);
    }

    .loading.show {
      display: flex;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--figma-color-border);
      border-top: 2px solid var(--figma-color-bg-brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .suggestions {
      display: none;
    }

    .suggestions.show {
      display: block;
    }

    .suggestion-item {
      background: var(--figma-color-bg);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .suggestion-header {
      display: flex;
      justify-content: between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .suggestion-type {
      background: var(--figma-color-bg-brand);
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .confidence {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
      margin-left: auto;
    }

    .suggestion-content {
      margin: 8px 0;
    }

    .suggestion-text {
      font-size: 12px;
      line-height: 1.4;
      margin-bottom: 8px;
      color: var(--figma-color-text);
      font-style: italic;
    }

    .value-comparison {
      display: flex;
      gap: 8px;
      font-size: 11px;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .value-comparison .current {
      color: var(--figma-color-text-secondary);
    }

    .value-comparison .suggested {
      color: var(--figma-color-bg-brand);
      font-weight: 500;
    }

    .suggestion-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .suggestion-actions .button {
      width: auto;
      padding: 6px 12px;
    }

    .error-message {
      background: #ff4757;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin: 16px 0;
      font-size: 12px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      background: #2ed573;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin: 16px 0;
      font-size: 12px;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    .config-section {
      margin-top: 24px;
    }

    .input-group {
      margin-bottom: 16px;
    }

    .input-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .input-group input, .input-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
    }

    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: var(--figma-color-bg-brand);
    }

    .collapsed {
      max-height: 40px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .collapsed.expanded {
      max-height: 500px;
    }

    .collapse-header {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--figma-color-border);
      margin-bottom: 12px;
    }

    .collapse-icon {
      transition: transform 0.3s ease;
    }

    .collapsed.expanded .collapse-icon {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🤖 CXS AI Chat Request</h1>
    <p>Intelligent suggestions for your designs</p>
  </div>

  <div class="section">
    <div class="selection-info">
      <span>Selection:</span>
      <span class="selection-count" id="selectionCount">0 elements</span>
    </div>
    
    <button class="button" id="analyzeBtn" disabled>
      Analyze Selection
    </button>
  </div>

  <div class="loading" id="loadingIndicator">
    <div class="spinner"></div>
    <span>AI is analyzing your design...</span>
  </div>

  <div class="error-message" id="errorMessage"></div>
  <div class="success-message" id="successMessage"></div>

  <div class="suggestions" id="suggestionsContainer">
    <div class="section">
      <h2>AI Suggestions</h2>
      <div id="suggestionsList"></div>
    </div>
  </div>

  <div class="section config-section">
    <div class="collapsed" id="configSection">
      <div class="collapse-header" onclick="toggleConfig()">
        <h2>Configuration</h2>
        <span class="collapse-icon">▼</span>
      </div>
      
      <div class="input-group">
        <label for="aiProvider">AI Provider:</label>
        <select id="aiProvider" onchange="updateProviderSettings()">
          <option value="azure-openai">Azure OpenAI</option>
          <option value="azure-foundry">Azure AI Foundry Agent</option>
          <option value="custom">Custom Endpoint</option>
        </select>
      </div>

      <div class="input-group">
        <label for="apiEndpoint">AI API Endpoint:</label>
        <input type="text" id="apiEndpoint" placeholder="API endpoint will be set based on provider selection" style="width: 100%; font-size: 11px;">
      </div>

      <div class="input-group">
        <label for="apiKey">API Key:</label>
        <input type="password" id="apiKey" placeholder="Enter your API key (optional)">
      </div>

      <div class="input-group">
        <label for="analysisType">Analysis Type:</label>
        <select id="analysisType">
          <option value="design-analysis">General Design Analysis</option>
          <option value="color-suggestion">Color Optimization</option>
          <option value="layout-optimization">Layout Optimization</option>
        </select>
      </div>

      <button class="button secondary" onclick="saveConfig()">Save Configuration</button>
    </div>
  </div>

  <script>
    console.log('🚀 INLINE SCRIPT LOADING - Fixed Architecture');
    
    // Global state
    let currentSuggestions = [];
    let config = {
      aiProvider: 'azure-openai',
      apiEndpoint: 'https://figma-plugin-api.politepebble-97923130.westus2.azurecontainerapps.io/api/analyze-anonymous',
      apiKey: '', // API key handled server-side via environment variables
      analysisType: 'design-analysis'
    };

    // Provider endpoints
    const providerEndpoints = {
      'azure-openai': 'https://figma-plugin-api.politepebble-97923130.westus2.azurecontainerapps.io/api/analyze-anonymous',
      'azure-foundry': 'https://figma-plugin-api.politepebble-97923130.westus2.azurecontainerapps.io/api/analyze-foundry',
      'custom': ''
    };

    // Load configuration from localStorage
    function loadConfig() {
      try {
        const savedConfig = localStorage.getItem('cxs-ai-config');
        if (savedConfig) {
          const parsed = JSON.parse(savedConfig);
          config = { ...config, ...parsed };
        }
      } catch (e) {
        console.warn('Could not load config from localStorage:', e);
      }
      
      // Update UI elements with loaded config
      const aiProviderSelect = document.getElementById('aiProvider');
      const apiEndpointInput = document.getElementById('apiEndpoint');
      const apiKeyInput = document.getElementById('apiKey');
      const analysisTypeSelect = document.getElementById('analysisType');
      
      if (aiProviderSelect) aiProviderSelect.value = config.aiProvider || 'azure-openai';
      if (apiEndpointInput) apiEndpointInput.value = config.apiEndpoint;
      if (apiKeyInput) apiKeyInput.value = config.apiKey || '';
      if (analysisTypeSelect) analysisTypeSelect.value = config.analysisType;
      
      // Update provider settings
      updateProviderSettings();
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('✅ DOM Ready - Setting up UI...');
      
      // Load saved configuration
      loadConfig();
      
      const analyzeBtn = document.getElementById('analyzeBtn');
      
      console.log('Buttons found:', {
        analyzeBtn: !!analyzeBtn
      });

      // Simple direct onclick handlers
      if (analyzeBtn) {
        analyzeBtn.onclick = function() {
          console.log('✅ ANALYZE CLICKED!');
          parent.postMessage({ pluginMessage: { type: 'analyze-selection' } }, '*');
        };
      }

      console.log('✅ All button handlers attached!');

      // Set up provider selector debugging and event handling
      const providerSelect = document.getElementById('aiProvider');
      if (providerSelect) {
        console.log('🎯 Provider select found, current value:', providerSelect.value);
        console.log('🔍 Available endpoints:', providerEndpoints);
        
        // Add change listener (backup to onchange in HTML)
        providerSelect.addEventListener('change', function(e) {
          console.log('🚨 PROVIDER CHANGED TO:', e.target.value);
          updateProviderSettings();
        });
        
        // Force initial update
        console.log('🔄 Calling updateProviderSettings() on load');
        updateProviderSettings();
      } else {
        console.error('❌ Provider select NOT FOUND in DOM');
      }

      // Request initial selection data
      parent.postMessage({ pluginMessage: { type: 'get-selection-data' } }, '*');
    });

    // Message handler
    window.onmessage = function(event) {
      const message = event.data.pluginMessage;
      console.log('UI received message:', message);

      switch (message.type) {
        case 'selection-data':
          updateSelectionInfo(message.data);
          break;
        case 'analysis-started':
          showLoading(true);
          showMessage(`Starting analysis of ${message.elementCount} elements...`, 'success');
          break;
        case 'get-ai-config':
          handleGetAIConfig(message.request);
          break;
        case 'ai-response':
          handleAIResponse(message.result, message.provider);
          break;
        case 'ai-error':
          handleAIError(message.error, message.provider);
          break;
        case 'error':
          showMessage(message.message, 'error');
          break;
        case 'success':
          showMessage(message.message, 'success');
          break;
        default:
          console.log('Unknown message type:', message.type);
      }
    };

    function updateSelectionInfo(selectionData) {
      const count = selectionData.length;
      const selectionCount = document.getElementById('selectionCount');
      const analyzeBtn = document.getElementById('analyzeBtn');
      
      if (selectionCount) {
        selectionCount.textContent = `${count} element${count !== 1 ? 's' : ''}`;
      }
      if (analyzeBtn) {
        analyzeBtn.disabled = count === 0;
      }
    }

    function showMessage(message, type) {
      const errorDiv = document.getElementById('errorMessage');
      const successDiv = document.getElementById('successMessage');
      
      if (type === 'error' && errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.add('show');
        if (successDiv) successDiv.classList.remove('show');
        
        setTimeout(() => {
          errorDiv.classList.remove('show');
        }, 5000);
      } else if (type === 'success' && successDiv) {
        successDiv.textContent = message;
        successDiv.classList.add('show');
        if (errorDiv) errorDiv.classList.remove('show');
        
        setTimeout(() => {
          successDiv.classList.remove('show');
        }, 3000);
      }
    }

    function showLoading(show) {
      const loadingDiv = document.getElementById('loadingIndicator');
      if (loadingDiv) {
        if (show) {
          loadingDiv.classList.add('show');
        } else {
          loadingDiv.classList.remove('show');
        }
      }
    }

    // Handle request from main thread for AI config
    function handleGetAIConfig(request) {
      console.log('📋 Main thread requesting AI config for:', request);
      
      // Get current configuration from UI
      const provider = document.getElementById('aiProvider')?.value || 'azure-openai';
      const apiEndpointInput = document.getElementById('apiEndpoint')?.value;
      const apiKey = document.getElementById('apiKey')?.value || config.apiKey;
      
      // Determine base URL from provider or input
      let baseUrl = 'https://figma-plugin-api.politepebble-97923130.westus2.azurecontainerapps.io';
      
      // If user has manually entered an endpoint, extract base URL
      if (apiEndpointInput && apiEndpointInput.trim()) {
        if (apiEndpointInput.includes('/api/analyze-')) {
          // Extract base URL from full endpoint
          baseUrl = apiEndpointInput.replace(/\/api\/analyze-.*$/, '');
        } else {
          baseUrl = apiEndpointInput;
        }
      }
      
      const currentConfig = {
        provider: provider,
        apiEndpoint: baseUrl, // Send base URL only, let main thread append provider-specific path
        apiKey: apiKey || 'test-api-key-12345'
      };
      
      console.log('📤 Sending config to main thread:', currentConfig);
      showLoading(true);
      
      // Send back to main thread for actual network request
      parent.postMessage({
        pluginMessage: {
          type: 'make-ai-request',
          request: request,
          provider: provider,
          config: currentConfig
        }
      }, '*');
    }

    // Handle successful AI response from main thread
    function handleAIResponse(result, provider) {
      console.log('✅ AI Response received from main thread:', result, 'Provider:', provider);
      showLoading(false);
      displayAnalysisResults(result);
    }

    // Handle AI error from main thread
    function handleAIError(error, provider) {
      console.error('❌ AI Error from main thread:', error, 'Provider:', provider);
      showLoading(false);
      showMessage(`Analysis failed: ${error}`, 'error');
    }

    function displayAnalysisResults(result) {
      const suggestionsContainer = document.getElementById('suggestionsContainer');
      const suggestionsList = document.getElementById('suggestionsList');
      
      if (!suggestionsContainer || !suggestionsList) {
        console.error('Suggestions containers not found');
        return;
      }
      
      // Clear previous results
      suggestionsList.innerHTML = '';
      
      if (result.suggestions && result.suggestions.length > 0) {
        // Show suggestions section
        suggestionsContainer.classList.add('show');
        
        // Store suggestions globally
        currentSuggestions = result.suggestions;
        
        // Add each suggestion
        result.suggestions.forEach((suggestion, index) => {
          const suggestionDiv = createSuggestionElement(suggestion, index);
          suggestionsList.appendChild(suggestionDiv);
        });
        
        showMessage(`Analysis complete! Found ${result.suggestions.length} suggestions.`, 'success');
      } else {
        // Show empty state
        suggestionsList.innerHTML = '<p style="color: var(--figma-color-text-secondary); text-align: center; padding: 20px;">No specific suggestions found. Your design looks good!</p>';
        suggestionsContainer.classList.add('show');
        showMessage('Analysis complete - no changes needed!', 'success');
      }
    }

    // Helper function to format suggestion values for display
    function formatSuggestionValue(value, type) {
        if (typeof value === 'object' && value !== null) {
            if (value.r !== undefined && value.g !== undefined && value.b !== undefined) {
                // Format Figma color object
                const r = Math.round(value.r * 255);
                const g = Math.round(value.g * 255);
                const b = Math.round(value.b * 255);
                return `RGB(${r}, ${g}, ${b})`;
            }
            // Other objects - just stringify
            return JSON.stringify(value);
        }
        
        // For numbers, check if it's a size/dimension
        if (typeof value === 'number' && (type?.includes('size') || type?.includes('font'))) {
            return `${value}px`;
        }
        
        return String(value);
    }

    function createSuggestionElement(suggestion, index) {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.innerHTML = `
        <div class="suggestion-header">
          <span class="suggestion-type">${suggestion.type || 'suggestion'}</span>
          <span class="confidence">${suggestion.confidence || 'High'} confidence</span>
        </div>
        <div class="suggestion-content">
          ${suggestion.reasoning ? `
            <div class="suggestion-text">${suggestion.reasoning}</div>
          ` : `
            <div class="suggestion-text">${suggestion.description || suggestion.text || 'Improvement suggestion'}</div>
          `}
          ${suggestion.currentValue && suggestion.suggestedValue ? `
            <div class="value-comparison">
              <span class="current">Current: ${suggestion.currentValue}</span>
              <span>→</span>
              <span class="suggested">Suggested: ${formatSuggestionValue(suggestion.suggestedValue, suggestion.type)}</span>
            </div>
          ` : ''}
        </div>
        <div class="suggestion-actions">
          <button class="button" onclick="applySuggestion(${index})">Apply</button>
          <button class="button secondary" onclick="dismissSuggestion(${index})">Dismiss</button>
        </div>
      `;
      return div;
    }

    function applySuggestion(index) {
      const suggestion = currentSuggestions[index];
      if (suggestion) {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'apply-suggestion', 
            suggestion: suggestion 
          } 
        }, '*');
        showMessage('Applying suggestion...', 'success');
      }
    }

    function dismissSuggestion(index) {
      const suggestionElements = document.querySelectorAll('.suggestion-item');
      if (suggestionElements[index]) {
        suggestionElements[index].style.opacity = '0.5';
        suggestionElements[index].style.pointerEvents = 'none';
      }
      showMessage('Suggestion dismissed', 'success');
    }

    // Expose functions for onclick handlers
    window.applySuggestion = applySuggestion;
    window.dismissSuggestion = dismissSuggestion;

    function toggleConfig() {
      const configSection = document.getElementById('configSection');
      if (configSection) {
        configSection.classList.toggle('expanded');
      }
    }

    function saveConfig() {
      const aiProvider = document.getElementById('aiProvider')?.value;
      const apiEndpoint = document.getElementById('apiEndpoint')?.value;
      const apiKey = document.getElementById('apiKey')?.value;
      const analysisType = document.getElementById('analysisType')?.value;
      
      if (aiProvider) config.aiProvider = aiProvider;
      if (apiEndpoint) config.apiEndpoint = apiEndpoint;
      if (apiKey) config.apiKey = apiKey;
      if (analysisType) config.analysisType = analysisType;
      
      // Save to localStorage
      try {
        localStorage.setItem('cxs-ai-config', JSON.stringify(config));
      } catch (e) {
        console.warn('Could not save config to localStorage:', e);
      }
      
      showMessage(`Configuration saved! Using ${aiProvider === 'azure-foundry' ? 'Azure AI Foundry Agent' : 'Azure OpenAI'}`, 'success');
      console.log('Config saved:', config);
    }

    function updateProviderSettings() {
      console.log('🔄 updateProviderSettings() called');
      
      // Visual indicator that function is running
      document.title = 'Provider Update: ' + new Date().toLocaleTimeString();
      
      const providerSelect = document.getElementById('aiProvider');
      const endpointInput = document.getElementById('apiEndpoint');
      
      console.log('🔍 Elements found:', {
        providerSelect: !!providerSelect,
        endpointInput: !!endpointInput,
        selectedValue: providerSelect?.value
      });
      
      if (providerSelect && endpointInput) {
        const selectedProvider = providerSelect.value;
        const defaultEndpoint = providerEndpoints[selectedProvider];
        
        console.log('🎯 Provider mapping:', {
          selectedProvider,
          defaultEndpoint,
          allEndpoints: providerEndpoints
        });
        
        if (defaultEndpoint) {
          console.log('🔄 Setting endpoint input value from:', endpointInput.value, 'to:', defaultEndpoint);
          endpointInput.value = defaultEndpoint;
          endpointInput.disabled = selectedProvider !== 'custom';
          console.log('✅ Updated endpoint to:', defaultEndpoint);
          console.log('✅ Input now shows:', endpointInput.value);
          
          // Force the visual update
          endpointInput.dispatchEvent(new Event('input'));
        } else {
          endpointInput.disabled = false;
          console.log('⚠️ No default endpoint found for provider:', selectedProvider);
        }
        
        // Update config
        config.aiProvider = selectedProvider;
        config.apiEndpoint = endpointInput.value;
        
        // Show provider-specific info
        const loadingDiv = document.getElementById('loadingIndicator');
        if (loadingDiv && selectedProvider === 'azure-foundry') {
          loadingDiv.querySelector('span').textContent = 'Azure AI Foundry agent is analyzing your design...';
        } else if (loadingDiv) {
          loadingDiv.querySelector('span').textContent = 'AI is analyzing your design...';
        }
      }
    }

    // Expose for onclick handlers
    window.toggleConfig = toggleConfig;
    window.saveConfig = saveConfig;
    window.updateProviderSettings = updateProviderSettings;

    console.log('📋 UI SCRIPT LOADED - Inline version');
  </script>
</body>
</html>